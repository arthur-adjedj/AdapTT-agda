{-# OPTIONS --rewriting #-}
{-# OPTIONS --allow-unsolved-metas #-}

open import Agda.Primitive
open import Agda.Builtin.Equality
open import Agda.Builtin.Equality.Rewrite

open import Std
open import Dir
open import AppC1
open import AppC2
open import AppC3


{- Appendix C.4 : Term variables in AdapTT2 -}
postulate
--CtxExtTm
  _โน[_]_      : (ฮ : Ctx) (d : Dir) โ Ty (ฮ ^ d) โ Ctx

-- SubExtTm
  _โนโ[_,_]_     : {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (d : Dir) (A : Ty (ฮ ^ d)) โ Tm (A [ ฯ ^โ d ]โ) โ Sub ฮ (ฮ โน[ d ] A)

-- WkTm
  WkTm        : (ฮ : Ctx) (d : Dir) (A : Ty (ฮ ^ d)) โ  Sub (ฮ โน[ d ] A) ฮ

-- VarZTm
  vztm        : {ฮ : Ctx} {A : Ty ฮ} โ Tm {ฮ = ฮ โน[ + ] A} (A [ WkTm ฮ + A ]โ)

-- SubTL
  SubTl        : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {A : Ty (ฮ ^ d)} (t : Tm(A [ ฯ ^โ d ]โ)) โ (WkTm ฮ d A) โ (ฯ โนโ[ d , A ] t) โก ฯ

-- SubEta
  SubEta        : {ฮ ฮ : Ctx} {A : Ty ฮ} (ฯ : Sub ฮ (ฮ โน[ + ] A)) โ ((WkTm ฮ + A) โ ฯ) โนโ[ + , A ] (vztm [ ฯ ]โ) โก ฯ

-- AdTmVarZ
  adapt-vztm   : {ฮ ฮ : Ctx} {A : Ty ฮ} {ฯ ฯ : Sub ฮ (ฮ โน[ + ] A)} (ฮผ : Trans ฮ (ฮ โน[ + ] A) ฯ ฯ) โ  adapt (A โฆ whiskerLeft (WkTm ฮ + A) ฮผ โง) (vztm [ ฯ ]โ) โก vztm [ ฯ ]โ

  {-#REWRITE SubTl #-}
-- SubTmExtVarZ
  SubHd : {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (A : Ty ฮ) (t : Tm (A [ ฯ ]โ)) โ vztm {A = A} [ ฯ โนโ[ + , A ] t ]โ โก t

-- TransTm+
  _โนโโ_       : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} {A : Ty ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) (t : Tm (A [ ฯ ]โ))
        โ Trans ฮ (ฮ โน[ + ] A) (ฯ โนโ[ + , A ] t ) (ฯ โนโ[ + , A ] (adapt (A โฆ ฮผ โง) t))

-- TransTm-
  _โนโโ_       : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} {A : Ty (ฮ ^ -)} (ฮผ : Trans ฮ ฮ ฯ ฯ) (t : Tm (A [ ฯ ^โ - ]โ))
         โ Trans ฮ (ฮ โน[ - ] A) (ฯ โนโ[ - , A ] adapt (A โฆ ฮผ ^โ - โง) t) (ฯ โนโ[ - , A ] t)

  {-#REWRITE SubEta #-}
-- TransTl+
  TransTlโ     : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) {A : Ty ฮ} (t : Tm (A [ ฯ ]โ)) โ whiskerLeft (WkTm ฮ + A) (ฮผ โนโโ t) โก ฮผ

-- TransTl-
  TransTlโ     : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) {A : Ty (ฮ ^ -)} (t : Tm (A [ ฯ ^โ - ]โ)) โ  whiskerLeft (WkTm ฮ - A) (ฮผ โนโโ t) โก ฮผ

  {-#REWRITE adapt-vztm #-}
-- TransEta
  TransEta     : {ฮ ฮ : Ctx} {A : Ty ฮ} {ฯ ฯ : Sub ฮ (ฮ โน[ + ] A)} (ฮผ : Trans ฮ (ฮ โน[ + ] A) ฯ ฯ) โ (whiskerLeft (WkTm ฮ + A) ฮผ) โนโโ (vztm [ ฯ ]โ) โก ฮผ

-- CtxExtTmDual
  โน^- : {ฮ : Ctx} (A : Ty (ฮ ^ d)) โ (ฮ โน[ d ] A) ^ - โก (ฮ ^ -) โน[ โ d ] A
  {-#REWRITE โน^- #-}

-- WkTmDual
  WkTm^- : {ฮ : Ctx} {d : Dir} (A : Ty (ฮ ^ d)) โ  (WkTm ฮ d A) ^โ - โก WkTm (ฮ ^ -) (โ d) A
  {-#REWRITE WkTm^- #-}

-- SubExtTmDual
  โนโ^- : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} (A : Ty (ฮ ^ d)) (t : Tm (A [ ฯ ^โ d ]โ)) โ (ฯ โนโ[ d , A ] t) ^โ - โก (ฯ ^โ -) โนโ[ โ d , A ] t
  {-#REWRITE โนโ^- #-}

-- TransTm+Dual
  โนโโ^- : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} {A : Ty ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) (t : Tm (A [ ฯ ]โ)) โ (_โนโโ_ {A = A} ฮผ t) ^โ - โก (ฮผ ^โ -) โนโโ t

-- TransTm-Dual
  โนโโ^- : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} {A : Ty (ฮ ^ -)} (ฮผ : Trans ฮ ฮ ฯ ฯ) (t : Tm (A [ ฯ ^โ - ]โ)) โ (_โนโโ_ {A = A} ฮผ t) ^โ - โก (ฮผ ^โ -) โนโโ t

-- TyTransSub
  โฆโง[]โ : (ฮ ฮ ฮ : Ctx) (ฯ ฮพ : Sub ฮ ฮ) (ฮผ : Trans ฮ ฮ ฯ ฮพ) (ฯ : Sub ฮ ฮ)
         (A : Ty ฮ) โ A โฆ ฮผ โง [ ฯ ]โ โก A โฆ whiskerRight ฮผ ฯ โง

-- TySubTrans
  []โฆโงโ : (ฮ ฮ ฮ : Ctx) (ฯ : Sub ฮ ฮ) (ฯ ฮพ : Sub ฮ ฮ) (ฮผ : Trans ฮ ฮ ฯ ฮพ)
         (A : Ty ฮ) โ A [ ฯ ]โ โฆ ฮผ โง โก A โฆ whiskerLeft ฯ ฮผ โง

-- provable lemmas to help agda with computations:
โโโ : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} โ โโ โ ฯ โก โโ
โโโ {ฯ = ฯ} = โterminal (โโ โ ฯ)

SubTlComp : {ฮ ฮ ฮ : Ctx} {A : Ty ฮ} {ฯ : Sub ฮ ฮ } {ฯ : Sub ฮ ฮ} {t : Tm (A [ ฯ ]โ) } โ WkTm ฮ + A โ (ฯ โนโ[ + , A ] t) โ ฯ โก ฯ โ ฯ
SubTlComp {ฮ} {ฮ} {ฮ} {A} {ฯ} {ฯ} {t} = sym (โassoc (WkTm ฮ + A) (ฯ โนโ[ + , A ] t) ฯ)
{-#REWRITE SubTlComp #-}

{-#REWRITE SubHd #-}
SubHdComp : {ฮ ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (ฯ : Sub ฮ ฮ) (A : Ty ฮ) (t : Tm (A [ ฯ ]โ)) โ vztm [ (ฯ โนโ[ + , A ] t) โ ฯ ]โ โก (t [ ฯ ]โ)
SubHdComp ฯ ฯ A t = sym ([โ]โ {ฯ = ฯ โนโ[ + , A ] t} {ฮด = ฯ} {x = vztm})
{-#REWRITE SubHdComp #-}

SubEta- : {ฮ ฮ : Ctx} {A : Ty (ฮ ^ -)} (ฯ : Sub ฮ (ฮ โน[ - ] A)) โ (((WkTm (ฮ ^ -) + A) โ (ฯ ^โ -)) โนโ[ + , A ] (vztm [ ฯ ^โ - ]โ)) ^โ - โก ฯ
SubEta- ฯ = ฯโปโป ฯ
{-#REWRITE SubEta- #-}

{-#REWRITE id^d โ^d #-}
โโนโ : {ฮ ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ} {A : Ty (ฮ ^ d)} {t : Tm (A [ ฯ ^โ d ]โ)} โ (ฯ โนโ[ d , A ] t) โ ฯ โก ((ฯ โ ฯ) โนโ[ d , A ] (t [ ฯ ^โ d ]โ))
โโนโ {+} {ฮ} {ฮ} {ฮ} {ฯ} {ฯ} {A} {t} = sym (SubEta ((ฯ โนโ[ + , A ] t) โ ฯ))
โโนโ { - } {ฮ} {ฮ} {ฮ} {ฯ} {ฯ} {A} {t} = sym (SubEta- ((ฯ โนโ[ - , A ] t) โ ฯ))
{-#REWRITE  โโนโ #-}

{-#REWRITE TransTlโ TransTlโ TransEta #-}
TransEta- : {ฮ ฮ : Ctx} {A : Ty (ฮ ^ -)} {ฯ ฯ : Sub ฮ (ฮ โน[ - ] A)} (ฮผ : Trans ฮ (ฮ โน[ - ] A) ฯ ฯ) โ (_โนโโ_ {A = A} (whiskerLeft (WkTm (ฮ ^ -) + A) (ฮผ ^โ -) ) (vztm {ฮ = ฮ ^ - } {A = A} [ ฯ ^โ - ]โ)) ^โ - โก ฮผ
TransEta- ฮผ = ฮผโปแต {d = - } {ฮผ = ฮผ}
{-#REWRITE TransEta- #-}

โน^d : (d' : Dir) {ฮ : Ctx} (A : Ty (ฮ ^ d)) โ (ฮ โน[ d ] A) ^ d' โก (ฮ ^ d') โน[ d ร d' ] A
โน^d + A = refl
โน^d - A = refl
{-#REWRITE โน^d #-}

โนโ^d : (d' : Dir) {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} (A : Ty (ฮ ^ d)) (t : Tm (A [ ฯ ^โ d ]โ)) โ (ฯ โนโ[ d , A ] t) ^โ d' โก (ฯ ^โ d') โนโ[ d ร d' , A ] t
โนโ^d + A t = refl
โนโ^d - A t = refl
{-#REWRITE โนโ^d #-}

{-#REWRITE [โ]โ [id]โ #-}
WkTmโนโvztm  : {ฮ : Ctx} {A : Ty ฮ} โ  WkTm ฮ + A โนโ[ + , A ] vztm โก id (ฮ โน[ + ] A)
WkTmโนโvztm {ฮ} {A} = SubEta (id (ฮ โน[ + ] A))
WkTmโนโvztmโ : {ฮ : Ctx} {A : Ty (ฮ ^ -)} โ  WkTm ฮ - A โนโ[ - , A ] vztm โก id (ฮ โน[ - ] A)
WkTmโนโvztmโ {ฮ} {A} = SubEta- (id (ฮ โน[ - ] A))
{-#REWRITE WkTmโนโvztm WkTmโนโvztmโ #-}

lemmaโ : {ฮ ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ)(ฯ : Sub ฮ ฮ) (A : Ty ฮ) (B : Ty ฮ) (a : Ad _ A (B [ ฯ ]โ)) (t : Tm (A [ ฯ ]โ)) โ (a [ WkTm ฮ + A ]โ) [ ฯ โนโ[ + , A ] t ]โ โก (a [ ฯ ]โ)
lemmaโ {ฮ} {ฮ} {ฮ} ฯ ฯ A B a t = [โ]โ a (ฯ โนโ[ + , A ] t) (WkTm ฮ + A)
{-#REWRITE lemmaโ #-}

lemmaโ : {ฮ ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ} (A : Ty ฮ) (B : Ty ฮ) (C : Ty ฮ) (b : Ad _ B (C [ ฯ ]โ)) โ (b [ ฯ ]โ) [ WkTm ฮ + A ]โ โก b [ ฯ โ (WkTm ฮ + A) ]โ
lemmaโ {ฮ} {ฮ} {ฮ} {ฯ} {ฯ} A B C b = [โ]โ b (WkTm ฮ + A) ฯ
{-#REWRITE lemmaโ #-}

{- Definable structure : parallel extension, and associated lemmas -}
_โนโน[_,_]_ : {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (d : Dir) {A : Ty (ฮ ^ d)} (B : Ty (ฮ ^ d)) (a : Ad _ A (B [ ฯ ^โ d ]โ)) โ Sub (ฮ โน[ d ] A) (ฮ โน[ d ] B)
ฯ โนโน[ + , A ] a = (ฯ โ (WkTm _ _ _)) โนโ[ + , A ] adapt (a [ WkTm _ _ _ ]โ) vztm
ฯ โนโน[ - , A ] a = ((ฯ ^โ -) โนโน[ + , A ] a) ^โ -

{-#REWRITE [id]โ [โ]โ id[]โ โ[]โ adaptid adaptโ #-}
idโนโนid : (ฮ : Ctx) (d : Dir) (A : Ty (ฮ ^ d)) โ id ฮ โนโน[ d , A ] (idโ {A = A}) โก id (ฮ โน[ d ] A)
idโนโนid ฮ + A = SubEta (id _)
idโนโนid ฮ - A = SubEta- (id _)

{-#REWRITE โโโ adapt[]โ #-}
โนโนโโนโน : (d : Dir) {ฮ ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ} {A : Ty (ฮ ^ d)} {B : Ty (ฮ ^ d)} {C : Ty (ฮ ^ d)} (a : Ad _ A (B [ ฯ ^โ d ]โ)) (b : Ad _ B (C [ ฯ ^โ d ]โ)) โ
        (ฯ โนโน[ d , C ] b) โ (ฯ โนโน[ d , B ] a) โก (ฯ โ ฯ) โนโน[ d , C ] ((b [ ฯ ^โ d ]โ) โโ a)
โนโนโโนโน + a b = refl
โนโนโโนโน - a b = refl

โนโนโโน : (d : Dir) {ฮ ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ} {A : Ty (ฮ ^ d)} {B : Ty (ฮ ^ d)} (t : Tm (A [ ฯ ^โ d ]โ)) (a : Ad _ A (B [ ฯ ^โ d ]โ)) โ
         (ฯ โนโน[ d , B ] a) โ (ฯ โนโ[ d , A ] t) โก (ฯ โ ฯ) โนโ[ d , B ] (adapt (a [ ฯ ^โ d ]โ) t)
โนโนโโน + t a = refl
โนโนโโน - t a = refl

{- Appendix C.5 : Telescopes -}
postulate
-- CtxExtTel
  _โนโ[_]_ : (ฮ : Ctx) โ (d : Dir) โ Tel (ฮ ^ d) โ Ctx

-- TelEmp
  โโ       : {ฮ : Ctx} โ Tel ฮ

-- TelExtTy
  _โนโ_     : {ฮ : Ctx} (ฮ : Tel ฮ) โ (A : Ty (ฮ โนโ[ + ] ฮ)) โ Tel ฮ

-- WkTel
  WkTel    : {ฮ : Ctx} (d : Dir) (ฮ : Tel (ฮ ^ d)) โ Sub (ฮ โนโ[ d ] ฮ) ฮ

-- SubTel
  _[_]โ    : {ฮ ฮ : Ctx} โ Tel ฮ โ Sub ฮ ฮ โ Tel ฮ

-- TransTel
  _โฆ_โงโ    : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} (ฮ : Tel ฮ) (ฮผ : Trans ฮ ฮ ฯ ฯ) โ TelAd ฮ (ฮ [ ฯ ]โ) (ฮ [ ฯ ]โ)

-- AdInst
  teladapt : {ฮ : Ctx} {ฮ ฮ' : Tel ฮ} โ TelAd ฮ ฮ ฮ' โ  Inst ฮ ฮ  โ Inst ฮ ฮ'

-- VarInst
  vinst : {ฮ : Ctx} (ฮ : Tel ฮ) โ Inst (ฮ โนโ[ + ] ฮ) (ฮ [ WkTel + ฮ ]โ)

-- SubExtInst
  _โนโแตข[_]โฆ_,_โง : {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (d : Dir) (ฮ : Tel (ฮ ^ d)) (ฮน : Inst (ฮ ^ d) (ฮ [ ฯ ^โ d ]โ)) โ Sub ฮ (ฮ โนโ[ d ] ฮ)

-- TransExt+Inst
  _โนโแตขโโฆ_,_โง : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) (ฮ : Tel ฮ) (ฮน : Inst ฮ (ฮ [ ฯ ]โ)) โ Trans ฮ (ฮ โนโ[ + ] ฮ) (ฯ โนโแตข[ + ]โฆ ฮ , ฮน โง) (ฯ โนโแตข[ + ]โฆ ฮ , teladapt (ฮ โฆ ฮผ โงโ) ฮน โง)

-- TransExt-Inst
  _โนโแตขโโฆ_,_โง : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) (ฮ : Tel (ฮ ^ -)) โ (ฮน : Inst (ฮ ^ -) (ฮ [ ฯ ^โ - ]โ)) โ Trans ฮ (ฮ โนโ[ - ] ฮ) (ฯ โนโแตข[ - ]โฆ ฮ , teladapt (ฮ โฆ ฮผ ^โ - โงโ) ฮน โง) (ฯ โนโแตข[ - ]โฆ ฮ , ฮน โง)

-- SubTelId
  [id]โ : {ฮ : Ctx} {ฮ : Tel ฮ} โ ฮ [ id ฮ ]โ โก ฮ

-- SubTelComp
  [โ]โ : {ฮ ฮ ฮฆ : Ctx} {ฯ : Sub ฮฆ ฮ} {ฮด : Sub ฮ ฮฆ} {ฮ : Tel ฮ} โ ฮ [ ฯ ]โ [ ฮด ]โ โก ฮ [ ฯ โ ฮด ]โ
  {-#REWRITE [โ]โ [id]โ #-}

-- SubTelOnEmp
  โโ[]โ : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} โ โโ {ฮ = ฮ} [ ฯ ]โ โก โโ
  {-#REWRITE โโ[]โ #-}

-- SubTelOnExt
  โนโ[] : {ฮ ฮ : Ctx} {ฮ : Tel ฮ} {A : Ty (ฮ โนโ[ + ] ฮ)} {ฯ : Sub ฮ ฮ} โ (ฮ โนโ A) [ ฯ ]โ โก (ฮ [ ฯ ]โ) โนโ (A [ (ฯ โ (WkTel + (ฮ [ ฯ ]โ))) โนโแตข[ + ]โฆ ฮ , vinst _ โง ]โ)
  {-#REWRITE โนโ[] #-}

-- SubInst
  _[_]โ : {ฮ ฮ : Ctx} {ฮ : Tel ฮ} โ Inst ฮ ฮ โ (ฯ : Sub ฮ ฮ) โ Inst ฮ (ฮ [ ฯ ]โ)

-- SubInstId
  [id]โ : {ฮ : Ctx} {ฮ : Tel ฮ} {ฮน : Inst ฮ ฮ} โ ฮน [ id ฮ ]โ โก ฮน

-- SubInstComp
  [โ]โ : {ฮ ฮ ฮฆ : Ctx} {ฯ : Sub ฮฆ ฮ} {ฮด : Sub ฮ ฮฆ} {ฮ : Tel ฮ} {ฮน : Inst ฮ ฮ} โ ฮน [ ฯ ]โ [ ฮด ]โ โก ฮน [ ฯ โ ฮด ]โ
  {-# REWRITE [id]โ [โ]โ #-}

-- TelAdId
  idโโ    : {ฮ : Ctx} {ฮ : Tel ฮ} โ TelAd ฮ ฮ ฮ

-- TelAdComp
  _โโโ_   : {ฮ : Ctx} {A B C : Tel ฮ} โ TelAd ฮ B C โ TelAd ฮ A B โ TelAd ฮ A C

-- SubTelAd
  _[_]โโ  : {ฮ ฮ : Ctx} {A B : Tel ฮ} โ TelAd ฮ A B โ (ฯ : Sub ฮ ฮ) โ TelAd ฮ (A [ ฯ ]โ) (B [ ฯ ]โ)

-- TelAdRightUnitality
  โโโid : {ฮ : Ctx} {A B : Tel ฮ} (ta : TelAd ฮ A B) โ ta โโโ idโโ โก ta

-- TelAdLeftUnitality
  idโโโ : {ฮ : Ctx} {A B : Tel ฮ} (ta : TelAd ฮ A B) โ idโโ โโโ ta โก ta

-- TelAdAssociatitvity
  โโโassoc : {ฮ : Ctx} {A B C D : Tel ฮ} (a : TelAd ฮ A B) (b : TelAd ฮ B C) (c : TelAd ฮ C D) โ c โโโ (b โโโ a) โก (c โโโ b) โโโ a
  {-#REWRITE โโโassoc โโโid idโโโ #-}

-- SubTelAdId
  [id]โโ  : {ฮ : Ctx} {A B : Tel ฮ} {ad : TelAd ฮ A B} โ ad [ id ฮ ]โโ โก ad

-- SubTelAdComp
  [โ]โโ   : {ฮ ฮ ฮ : Ctx} {A B : Tel ฮ} (a : TelAd ฮ A B) (ฯ : Sub ฮ ฮ) (ฯ : Sub ฮ ฮ) โ a [ ฯ ]โโ [ ฯ ]โโ โก a [ ฯ โ ฯ ]โโ

-- SubTelAdOnId
  id[]โโ  : {ฮ ฮ : Ctx} {A : Tel ฮ} (ฯ : Sub ฮ ฮ) โ idโโ {ฮ = A} [ ฯ ]โโ โก idโโ

-- SubTelAdOnComp
  โ[]โโ : {ฮ ฮ : Ctx} {A B C : Tel ฮ} (a : TelAd ฮ B C) (b : TelAd ฮ A B) (ฯ : Sub ฮ ฮ) โ (a โโโ b) [ ฯ ]โโ โก (a [ ฯ ]โโ) โโโ (b [ ฯ ]โโ)
  {-#REWRITE [id]โโ [โ]โโ id[]โโ โ[]โโ #-}

-- TransTelNaturality
  TelAdaptTrans   : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} {A B : Tel ฮ} (f : TelAd ฮ A B) (ฮผ : Trans ฮ ฮ ฯ ฯ) โ (B โฆ ฮผ โงโ) โโโ (f [ ฯ ]โโ) โก (f [ ฯ ]โโ) โโโ (A โฆ ฮผ โงโ)

-- TransTelId
  โฆidโงโ : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฮ : Tel ฮ} โ ฮ โฆ idโ {ฯ = ฯ} โงโ โก idโโ

-- SubTelAdTransTel
  SubTelAdTransTel : {ฮ ฮ ฮ : Ctx} {ฮ : Tel ฮ} {ฯ ฯ : Sub ฮ ฮ} {ฮผ : Trans ฮ ฮ ฯ ฯ} (ฮพ : Sub ฮ ฮ) โ (ฮ โฆ ฮผ โงโ)[ ฮพ ]โโ โก ฮ โฆ whiskerRight ฮผ ฮพ โงโ

-- TransTelSubTel
  TransTelSubTel : {ฮ ฮ ฮ : Ctx} {ฮ : Tel ฮ}  {ฯ : Sub ฮ ฮ} {ฯ ฮพ : Sub ฮ ฮ} {๐ : Trans ฮ ฮ ฯ ฮพ} โ (ฮ [ ฯ ]โ)โฆ ๐ โงโ โก  ฮ โฆ whiskerLeft ฯ ๐ โงโ

-- InstTransTel
  InstTransTel : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} {A : Tel ฮ} (t : Inst ฮ A) (ฮผ : Trans ฮ ฮ ฯ ฯ) โ (teladapt (A โฆ ฮผ โงโ) (t [ ฯ ]โ)) โก (t [ ฯ ]โ)
  {-#REWRITE TelAdaptTrans InstTransTel #-}

-- AdInstId
  teladapt-id : {ฮ : Ctx} {ฮ : Tel ฮ} (ฮน : Inst ฮ ฮ) โ teladapt (idโโ {ฮ = ฮ}) ฮน โก ฮน

-- AdInstComp
  teladaptโ : {ฮ : Ctx} {ฮ ฮ' ฮ'' : Tel ฮ} (ta : TelAd ฮ ฮ ฮ') (ta' : TelAd ฮ ฮ' ฮ'') (ฮน : Inst ฮ ฮ) โ teladapt (ta' โโโ ta) ฮน โก teladapt ta' (teladapt ta ฮน)
  {-#REWRITE teladapt-id teladaptโ #-}

-- SubInstOnAdInst
  teladapt[]โ : {ฮ ฮ : Ctx} {A B : Tel ฮ} (a : TelAd ฮ A B) (t : Inst ฮ A) (ฯ : Sub ฮ ฮ) โ (teladapt a t) [ ฯ ]โ โก teladapt (a [ ฯ ]โโ) (t [ ฯ ]โ)
  {-#REWRITE teladapt[]โ #-}

-- CtxExtTelDual
  โนโ^- : {ฮ : Ctx} (ฮ : Tel (ฮ ^ d)) โ (ฮ โนโ[ d ] ฮ) ^ - โก (ฮ ^ -) โนโ[ โ d ] ฮ
  {-#REWRITE โนโ^- #-}

-- SubExtInstDual
  โนโแตข^- : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} (ฮ : Tel (ฮ ^ d)) (ฮน : Inst (ฮ ^ d) (ฮ [ ฯ ^โ d ]โ)) โ (ฯ โนโแตข[ d ]โฆ ฮ , ฮน โง) ^โ - โก ((ฯ ^โ -) โนโแตข[ โ d ]โฆ ฮ , ฮน โง)
  {-#REWRITE โนโแตข^- #-}

-- WkTelDual
  WkTel^- : {ฮ : Ctx} (ฮ : Tel (ฮ ^ d)) โ (WkTel {ฮ} d ฮ) ^โ - โก WkTel {ฮ ^ - } (โ d) ฮ
  {-#REWRITE WkTel^- #-}

-- VarInstAdTrans
  adapt-vinst : {ฮ ฮ : Ctx} {A : Tel ฮ} {ฯ ฯ : Sub ฮ (ฮ โนโ[ + ] A)} (ฮผ : Trans ฮ (ฮ โนโ[ + ] A) ฯ ฯ) โ  teladapt (A โฆ whiskerLeft (WkTel + A) ฮผ โงโ) (vinst A [ ฯ ]โ) โก vinst A [ ฯ ]โ
  {-#REWRITE adapt-vinst #-}

-- InstEmp
  โแตข : {ฮ : Ctx} โ Inst ฮ โโ

-- InstExtTm
  [_]_โนแตข_ : (ฮ : Ctx) {ฮ : Tel ฮ} (ฮน : Inst ฮ ฮ) {T : Ty (ฮ โนโ[ + ] ฮ)} โ Tm (T [ id ฮ โนโแตข[ + ]โฆ ฮ , ฮน โง ]โ) โ Inst ฮ (ฮ โนโ T)

-- InstTelEmp
  โโโโแตข : {ฮ : Ctx} (ฮน : Inst ฮ โโ) โ ฮน โก โแตข

-- SubOnInstEmp
  โแตข[] : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} โ โแตข [ ฯ ]โ โก โแตข
  {-#REWRITE โแตข[] #-}

-- SubExtInstTl
  SubTlแตข        : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฮ : Tel (ฮ ^ d)} (ฮน : Inst (ฮ ^ d) (ฮ [ ฯ ^โ d ]โ)) โ (WkTel d ฮ) โ (ฯ โนโแตข[ d ]โฆ ฮ , ฮน โง) โก ฯ
  {-#REWRITE SubTlแตข #-}

-- SubExtInstEta
  SubEtaแตข        : {ฮ ฮ : Ctx} {ฮ : Tel ฮ} (ฯ : Sub ฮ (ฮ โนโ[ + ] ฮ)) โ ((WkTel + ฮ) โ ฯ) โนโแตข[ + ]โฆ ฮ , (vinst ฮ [ ฯ ]โ) โง โก ฯ
  {-#REWRITE SubEtaแตข #-}

-- SubInstExtVarInst
  SubHdแตข : {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (ฮ : Tel ฮ) (t : Inst ฮ (ฮ [ ฯ ]โ)) โ vinst ฮ [ ฯ โนโแตข[ + ]โฆ ฮ , t โง ]โ โก t
  {-#REWRITE SubHdแตข #-}

-- Provable lemmas needed for computations

SubTlแตขComp : {ฮ ฮ ฮ : Ctx} {A : Tel ฮ} {ฯ : Sub ฮ ฮ } {ฯ : Sub ฮ ฮ} {t : Inst _ (A [ ฯ ]โ) } โ WkTel + A โ (ฯ โนโแตข[ + ]โฆ A , t โง) โ ฯ โก ฯ โ ฯ
SubTlแตขComp {ฮ} {ฮ} {ฮ} {A} {ฯ} {ฯ} {t} = sym (โassoc (WkTel + A) (ฯ โนโแตข[ + ]โฆ A , t โง) ฯ)
{-#REWRITE SubTlแตขComp #-}

SubHdแตขComp : {ฮ ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (ฯ : Sub ฮ ฮ) (A : Tel ฮ) (t : Inst _ (A [ ฯ ]โ)) โ (vinst A) [ (ฯ โนโแตข[ + ]โฆ A , t โง) โ ฯ ]โ โก (t [ ฯ ]โ)
SubHdแตขComp ฯ ฯ A t = sym ([โ]โ {ฯ = ฯ โนโแตข[ + ]โฆ A , t โง} {ฮด = ฯ} {ฮน = vinst A})
{-#REWRITE SubHdแตขComp #-}

SubEtaแตข- : {ฮ ฮ : Ctx} {A : Tel (ฮ ^ -)} (ฯ : Sub ฮ (ฮ โนโ[ - ] A)) โ (((WkTel + A) โ (ฯ ^โ -)) โนโแตข[ + ]โฆ A , ((vinst A) [ ฯ ^โ - ]โ) โง) ^โ -  โก ฯ
SubEtaแตข- ฯ = ฯโปโป ฯ
{-#REWRITE SubEtaแตข- #-}

โแตขโนโแตข : {d : Dir} {ฮ ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ} {ฮ : Tel (ฮ ^ d)} {ฮน : Inst (ฮ ^ d) (ฮ [ ฯ ^โ d ]โ)} โ (ฯ โนโแตข[ d ]โฆ ฮ , ฮน โง) โ ฯ โก ((ฯ โ ฯ) โนโแตข[ d ]โฆ ฮ , ฮน [ ฯ ^โ d ]โ โง )
โแตขโนโแตข {+} {ฮ} {ฮ} {ฮ} {ฯ} {ฯ} {ฮ} {ฮน} = sym (SubEtaแตข (ฯ โนโแตข[ + ]โฆ ฮ , ฮน โง โ ฯ))
โแตขโนโแตข { - } {ฮ} {ฮ} {ฮ} {ฯ} {ฯ} {ฮ} {ฮน} = sym (SubEtaแตข- (ฯ โนโแตข[ - ]โฆ ฮ , ฮน โง โ ฯ))
{-#REWRITE โแตขโนโแตข #-}

SubEtaidแตข : {ฮ : Ctx} {ฮ : Tel ฮ} โ (WkTel + ฮ) โนโแตข[ + ]โฆ ฮ , vinst ฮ โง โก id (ฮ โนโ[ + ] ฮ)
SubEtaidแตข {ฮ} {ฮ} = SubEtaแตข (id (ฮ โนโ[ + ] ฮ))
{-#REWRITE SubEtaidแตข #-}

โนโ^d : (d' : Dir) {ฮ : Ctx} (ฮ : Tel (ฮ ^ d)) โ (ฮ โนโ[ d ] ฮ) ^ d' โก (ฮ ^ d') โนโ[ d' ร d ] ฮ
โนโ^d + ฮ = refl
โนโ^d - ฮ = refl
{-#REWRITE โนโ^d #-}
โนโแตข^d : (d' : Dir) {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} (ฮ : Tel (ฮ ^ d)) (ฮน : Inst (ฮ ^ d) (ฮ [ ฯ ^โ d ]โ)) โ (ฯ โนโแตข[ d ]โฆ ฮ , ฮน โง) ^โ d' โก ((ฯ ^โ d') โนโแตข[ d' ร d ]โฆ ฮ , ฮน โง)
โนโแตข^d + ฮ ฮน = refl
โนโแตข^d - ฮ ฮน = refl
{-#REWRITE โนโแตข^d #-}


postulate
-- CtxExtTelEmp
  โนโโ  : {ฮ : Ctx} โ ฮ โนโ[ d ] โโ โก ฮ

-- CtxExtTelExt
  โนโโน : (d : Dir) {ฮ : Ctx} (ฮ : Tel (ฮ ^ d)) (A : Ty ((ฮ ^ d) โนโ[ + ] ฮ)) โ ฮ โนโ[ d ] (ฮ โนโ A) โก (ฮ โนโ[ d ] ฮ) โน[ d ] A
  {-#REWRITE โนโโ โนโโน #-}

-- WkTelWkTy
  WkTelโน : {d : Dir} {ฮ : Ctx} {ฮ : Tel (ฮ ^ d)} {A : Ty ((ฮ ^ d) โนโ[ + ] ฮ)} โ WkTel {ฮ} d ฮ โ WkTm (ฮ โนโ[ d ] ฮ) d A โก WkTel d (ฮ โนโ A)
  {-#REWRITE WkTelโน #-}

-- more provable lemmas
โนโโโ  : {ฮ : Ctx} โ ฮ โนโ[ + ] โโ โก ฮ
โนโโโ {ฮ} = โนโโ {d = +} {ฮ}
{-#REWRITE โนโโโ #-}
โนโโโน : {ฮ : Ctx} (ฮ : Tel ฮ) (A : Ty (ฮ โนโ[ + ] ฮ)) โ ฮ โนโ[ + ] (ฮ โนโ A) โก (ฮ โนโ[ + ] ฮ) โน[ + ] A
โนโโโน ฮ A = โนโโน + ฮ A
{-#REWRITE โนโโโน #-}


lemma : (ฮ ฮ : Ctx)(ฯ : Sub ฮ ฮ) (ฮ : Tel ฮ) (t : Inst ฮ (ฮ [ ฯ ]โ)) โ vinst (ฮ [ ฯ ]โ) [ id ฮ โนโแตข[ + ]โฆ ฮ [ ฯ ]โ , t โง ]โ โก t
lemma ฮ ฮ ฯ ฮ t = SubHdแตข (id ฮ) (ฮ [ ฯ ]โ) t
{-#REWRITE lemma #-}

lemmaโ : {ฮ ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ)(ฯ : Sub ฮ ฮ) (ฮ : Tel ฮ) (ฮ' : Tel ฮ) (a : TelAd ฮ ฮ (ฮ' [ ฯ ]โ)) (t : Inst ฮ (ฮ [ ฯ ]โ)) โ (a [ WkTel + ฮ ]โโ) [ ฯ โนโแตข[ + ]โฆ ฮ , t โง ]โโ โก (a [ ฯ ]โโ)
lemmaโ ฯ ฯ ฮ ฮ' a t = [โ]โโ a (WkTel + ฮ) (ฯ โนโแตข[ + ]โฆ ฮ , t โง)
{-#REWRITE lemmaโ #-}

lemmaโ : {ฮ ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ} (A : Tel ฮ) (B : Tel ฮ) (C : Tel ฮ) (b : TelAd ฮ B (C [ ฯ ]โ)) โ b [ ฯ ]โโ [ WkTel + A ]โโ โก (b [ ฯ โ (WkTel + A) ]โโ)
lemmaโ {ฮ} {ฮ} {ฮ} {ฯ} {ฯ} A B C b = [โ]โโ b ฯ (WkTel + A)
{-#REWRITE lemmaโ #-}

-- {- Derivable operations : telescopic parallel extension  -}
-- SubTelAd
_โนโนโ[_]โฆ_,_โง : {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (d : Dir) {ฮ : Tel (ฮ ^ d)} (ฮ' : Tel (ฮ ^ d)) (t : TelAd (ฮ ^ d) ฮ (ฮ' [ ฯ ^โ d ]โ)) โ Sub (ฮ โนโ[ d ] ฮ) (ฮ โนโ[ d ] ฮ')
_โนโนโ[_]โฆ_,_โง {ฮ} {ฮ} ฯ + {ฮ} ฮ' t = (ฯ โ (WkTel {ฮ = ฮ} + ฮ)) โนโแตข[ + ]โฆ ฮ' , teladapt (t [ WkTel {ฮ = ฮ} + ฮ ]โโ) (vinst ฮ) โง
ฯ โนโนโ[ - ]โฆ ฮ' , t โง = ((ฯ ^โ -) โนโนโ[ + ]โฆ ฮ' , t โง) ^โ -

idโนโนโid : (ฮ : Ctx) (d : Dir) (ฮ : Tel (ฮ ^ d)) โ (id ฮ) โนโนโ[ d ]โฆ ฮ , idโโ {ฮ = ฮ} โง โก id (ฮ โนโ[ d ] ฮ)
idโนโนโid ฮ + A = refl
idโนโนโid ฮ - A = refl

โนโนโโโนโนโ : {ฮ ฮ ฮ : Ctx} (d : Dir) {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ} {ฮ : Tel (ฮ ^ d)} {ฮ' : Tel (ฮ ^ d)} {ฮ'' : Tel (ฮ ^ d)} (a : TelAd (ฮ ^ d) ฮ (ฮ' [ ฯ ^โ d ]โ)) (b : TelAd (ฮ ^ d) ฮ' (ฮ'' [ ฯ ^โ d ]โ)) โ
        (ฯ โนโนโ[ d ]โฆ ฮ'' , b โง) โ (ฯ โนโนโ[ d ]โฆ ฮ' , a โง) โก (ฯ โ ฯ) โนโนโ[ d ]โฆ ฮ'' , (b [ ฯ ^โ d ]โโ) โโโ a โง
โนโนโโโนโนโ + a b = refl
โนโนโโโนโนโ - a b = refl

โนโนโโโน : (d : Dir) {ฮ ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ} {A : Tel (ฮ ^ d)} {B : Tel (ฮ ^ d)} (t : Inst _ (A [ ฯ ^โ d ]โ)) (a : TelAd (ฮ ^ d) A (B [ ฯ ^โ d ]โ)) โ (ฯ โนโนโ[ d ]โฆ B , a โง) โ (ฯ โนโแตข[ d ]โฆ A , t โง) โก (ฯ โ ฯ) โนโแตข[ d ]โฆ B , teladapt (a [ ฯ ^โ d ]โโ) t โง
โนโนโโโน + t a = refl
โนโนโโโน - t a = refl
{-#REWRITE idโนโนโid #-}

SubEtaWkTelCons : {ฮ : Ctx} {ฮ : Tel ฮ} {A : Ty (ฮ โนโ[ + ] ฮ)}  โ (WkTel + (ฮ โนโ A)) โนโแตข[ + ]โฆ ฮ , (vinst ฮ) [ WkTm (ฮ โนโ[ + ] ฮ) + A ]โ โง โก  WkTm (ฮ โนโ[ + ] ฮ) + A
SubEtaWkTelCons {ฮ} {ฮ} {A} = SubEtaแตข {ฮ = ฮ} (WkTm (ฮ โนโ[ + ] ฮ) + A)
{-#REWRITE SubEtaWkTelCons #-}

postulate
-- VarInstExtVarZ
  VarInstExtVarZ : (d : Dir) {ฮ : Ctx} {ฮ : Tel (ฮ ^ d)} {A : Ty ((ฮ ^ d) โนโ[ + ] ฮ)} โ
    vinst (ฮ โนโ A) โก
    ([ (ฮ ^ d) โนโ[ + ] (ฮ โนโ A) ] (vinst ฮ) [ WkTm ((ฮ ^ d) โนโ[ + ] ฮ) + A ]โ โนแตข  vztm)

-- SubExtInstEmp
  โนโแตขโแตข : {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ)  โ ฯ โนโแตข[ d ]โฆ โโ , โแตข โง โก ฯ
  {-#REWRITE โนโแตขโแตข #-}

-- SubExtInstExt
  โนโแตขโนแตข : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฮ : Tel ฮ} (ฮน : Inst ฮ (ฮ [ ฯ ]โ)) {A : Ty (ฮ โนโ[ + ] ฮ)} (t : Tm (A [ ฯ โนโแตข[ + ]โฆ ฮ , ฮน โง ]โ)) โ ฯ โนโแตข[ + ]โฆ ฮ โนโ A , ([ ฮ ] ฮน โนแตข t) โง โก ((ฯ โนโแตข[ + ]โฆ ฮ , ฮน โง) โนโ[ + , A ] t)

-- TelAdExt
  _โนโโ_ : {ฮ : Ctx} {ฮ ฮ' : Tel ฮ} (ta : TelAd ฮ ฮ ฮ') {A : Ty (ฮ โนโ[ + ] ฮ)} {A' : Ty (ฮ โนโ[ + ] ฮ')} (a : Ad _ A (A' [ id ฮ โนโนโ[ + ]โฆ ฮ' , ta โง ]โ)) โ TelAd ฮ (ฮ โนโ A) (ฮ' โนโ A')

-- TelAdExtId
  idโนโโid : {ฮ : Ctx} {ฮ : Tel ฮ} {A : Ty (ฮ โนโ[ + ] ฮ)}  โ _โนโโ_ {ฮ} {ฮ} {ฮ} (idโโ {ฮ} {ฮ}) {A} {A} (idโ {A = A}) โก idโโ

-- TelAdExtComp
  โโนโโโ  : {ฮ : Ctx} {ฮ ฮ' ฮ'' : Tel ฮ}
          (ta : TelAd ฮ ฮ ฮ') (ta' : TelAd ฮ ฮ' ฮ'')
          {A : Ty (ฮ โนโ[ + ] ฮ)} {A' : Ty (ฮ โนโ[ + ] ฮ')}
          {A'' : Ty (ฮ โนโ[ + ] ฮ'')}
          (a : Ad _ A (A' [ id ฮ โนโนโ[ + ]โฆ _ , ta โง  ]โ))
          (b : Ad _ A' (A'' [ id ฮ โนโนโ[ + ]โฆ _ , ta' โง ]โ)) โ
          (_โนโโ_ {ฮ} {ฮ'} {ฮ''} ta'{A'} {A''} b) โโโ (_โนโโ_ {ฮ} {ฮ} {ฮ'} ta {A} {A'} a) โก (_โนโโ_ {ฮ} {ฮ} {ฮ''} (ta' โโโ ta) {A} {A''} ((b [ id (ฮ) โนโนโ[ + ]โฆ _ , ta โง ]โ) โโ a))

-- TransInst+
  _โนโแตขโโฆ_,_โง  : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ}  (ฮผ : Trans ฮ ฮ ฯ ฯ) (ฮ : Tel ฮ) (ฮน : Inst ฮ (ฮ [ ฯ ]โ)) โ Trans ฮ (ฮ โนโ[ + ] ฮ) (ฯ โนโแตข[ + ]โฆ ฮ , ฮน โง) (ฯ โนโแตข[ + ]โฆ ฮ , teladapt (ฮ โฆ ฮผ โงโ) ฮน โง)

-- TransInst-
  _โนโแตขโโฆ_,_โง  : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) (ฮ : Tel (ฮ ^ -)) (ฮน : Inst (ฮ ^ -) (ฮ [ ฯ ^โ - ]โ)) โ Trans ฮ (ฮ โนโ[ - ] ฮ) (ฯ โนโแตข[ - ]โฆ ฮ , teladapt (ฮ โฆ ฮผ ^โ - โงโ) ฮน โง ) (ฯ โนโแตข[ - ]โฆ ฮ , ฮน โง)

-- TransInst+Tl
  TransTlแตขโ     : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) {ฮ : Tel ฮ} (ฮน : Inst ฮ (ฮ [ ฯ ]โ)) โ whiskerLeft (WkTel + ฮ) (ฮผ โนโแตขโโฆ ฮ , ฮน โง) โก ฮผ

-- TransInst-Tl
  TransTlแตขโ     : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) {ฮ : Tel (ฮ ^ -)} (ฮน : Inst (ฮ ^ -) (ฮ [ ฯ ^โ - ]โ)) โ  whiskerLeft (WkTel - ฮ) (ฮผ โนโแตขโโฆ ฮ , ฮน โง) โก ฮผ

-- TransInstEta
  TransEtaแตข     : {ฮ ฮ : Ctx} {ฮ : Tel ฮ} {ฯ ฯ : Sub ฮ (ฮ โนโ[ + ] ฮ)} (ฮผ : Trans ฮ (ฮ โนโ[ + ] ฮ) ฯ ฯ) โ (whiskerLeft (WkTel + ฮ) ฮผ) โนโแตขโโฆ ฮ , vinst ฮ [ ฯ ]โ โง  โก ฮผ
  {-#REWRITE TransTlแตขโ TransTlแตขโ TransEtaแตข #-}

-- TransInst+Dual
  โนโแตขโ^- : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} {ฮ : Tel ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) (ฮน : Inst ฮ (ฮ [ ฯ ]โ)) โ (ฮผ โนโแตขโโฆ ฮ , ฮน โง) ^โ - โก (ฮผ ^โ -) โนโแตขโโฆ ฮ , ฮน โง
  {-#REWRITE โนโแตขโ^- #-}

-- TransInst-Dual
  โนโแตขโ^- : {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} {ฮ : Tel (ฮ ^ -)} (ฮผ : Trans ฮ ฮ ฯ ฯ) (ฮน : Inst (ฮ ^ -) (ฮ [ ฯ ^โ - ]โ)) โ (ฮผ โนโแตขโโฆ ฮ , ฮน โง) ^โ - โก (ฮผ ^โ -) โนโแตขโโฆ ฮ , ฮน โง
  {-#REWRITE โนโแตขโ^- #-}

-- TelExtTel
  _++โ_ : {ฮ : Ctx} (ฮโ : Tel ฮ) (ฮโ : Tel (ฮ โนโ[ + ] ฮโ)) โ Tel ฮ

-- InstExtInst
  _++แตข_ : {ฮ : Ctx} {ฮโ : Tel ฮ} (ฮนโ : Inst ฮ ฮโ) {ฮโ : Tel (ฮ โนโ[ + ] ฮโ)} (ฮนโ : Inst (ฮ โนโ[ + ] ฮโ) ฮโ) โ Inst ฮ (ฮโ ++โ ฮโ)

-- CtxExtTelExtTel
  โนโ++โ : {ฮ : Ctx} (ฮโ : Tel ฮ) (ฮโ : Tel (ฮ โนโ[ + ] ฮโ)) โ ฮ โนโ[ + ] (ฮโ ++โ ฮโ) โก ((ฮ โนโ[ + ] ฮโ) โนโ[ + ] ฮโ)
  {-# REWRITE โนโ++โ #-}

-- TelExtTelEmp
  ++โโโ : {ฮ : Ctx} (ฮโ : Tel ฮ) โ ฮโ ++โ โโ โก ฮโ
  {-#REWRITE ++โโโ #-}

-- TelExtTelExtTy
  ++โโนโ : {ฮ : Ctx} (ฮโ : Tel ฮ) (ฮโ : Tel (ฮ โนโ[ + ] ฮโ)) (A : Ty ((ฮ โนโ[ + ] ฮโ) โนโ[ + ] ฮโ)) โ ฮโ ++โ (ฮโ โนโ A) โก (ฮโ ++โ ฮโ) โนโ A
  {-#REWRITE ++โโนโ #-}

-- TelExtTelExtTel
  ++โ++โ : {ฮ : Ctx} (ฮโ : Tel ฮ) (ฮโ : Tel (ฮ โนโ[ + ] ฮโ)) (ฮโ : Tel ((ฮ โนโ[ + ] ฮโ) โนโ[ + ] ฮโ)) โ ฮโ ++โ (ฮโ ++โ ฮโ) โก (ฮโ ++โ ฮโ) ++โ ฮโ
  {-#REWRITE ++โ++โ #-}

-- SubTelOnExtTel
  ++โ[] : {ฮ ฮ : Ctx}
    (ฯ : Sub ฮ ฮ)
    (ฮโ : Tel ฮ) (ฮโ : Tel (ฮ โนโ[ + ] ฮโ)) โ
    (ฮโ ++โ ฮโ) [ ฯ ]โ โก (ฮโ [ ฯ ]โ) ++โ (ฮโ [ ฯ โนโนโ[ + ]โฆ ฮโ , idโโ {ฮ = ฮโ [ ฯ ]โ} โง ]โ)
  {-#REWRITE ++โ[]  #-}

-- WkTelWkTel
  WkTel++โWkTel : {ฮ : Ctx} (ฮโ : Tel ฮ) (ฮโ : Tel (ฮ โนโ[ + ] ฮโ)) โ WkTel + ฮโ โ WkTel + ฮโ โก WkTel + (ฮโ ++โ ฮโ)
  {-#REWRITE WkTel++โWkTel #-}

-- TelAdExtTelAd
  _++โโโฆ_,_โง :
     {ฮ : Ctx}
     {ฮโ ฮโ' : Tel ฮ} (taโ : TelAd ฮ ฮโ ฮโ')
    {ฮโ : Tel (ฮ โนโ[ + ] ฮโ)} (ฮโ' : Tel (ฮ โนโ[ + ] ฮโ')) (taโ :  TelAd (ฮ โนโ[ + ] ฮโ) ฮโ (ฮโ' [ id ฮ โนโนโ[ + ]โฆ _ , taโ โง ]โ))
    โ TelAd ฮ (ฮโ ++โ ฮโ) (ฮโ' ++โ ฮโ')

-- TelAdExtTelAdEmp
  _++โโโฆโโโง :
    {ฮ : Ctx}
    {ฮโ ฮโ' : Tel ฮ} (taโ : TelAd ฮ ฮโ ฮโ')
    (taโ :  TelAd (ฮ โนโ[ + ] ฮโ) โโ โโ)
    โ taโ ++โโโฆ โโ , taโ โง โก taโ
  {-# REWRITE _++โโโฆโโโง #-}

-- TelAdExtTelAdExtAd
  _++โโโฆโนโโง :
    {ฮ : Ctx}
    {ฮโ ฮโ' : Tel ฮ} (taโ : TelAd ฮ ฮโ ฮโ')
    {ฮโ : Tel (ฮ โนโ[ + ] ฮโ)}
    {ฮโ : Tel (ฮ โนโ[ + ] ฮโ)} (ฮโ' : Tel (ฮ โนโ[ + ] ฮโ')) (taโ :  TelAd (ฮ โนโ[ + ] ฮโ) ฮโ (ฮโ' [ id ฮ โนโนโ[ + ]โฆ _ , taโ โง ]โ))
    {A : Ty ((ฮ โนโ[ + ] ฮโ) โนโ[ + ] ฮโ)} {A' : Ty ((ฮ โนโ[ + ] ฮโ') โนโ[ + ] ฮโ')}
    (a :  Ad _ A (A' [ id ฮ โนโนโ[ + ]โฆ _ , taโ โง โนโนโ[ + ]โฆ _ , taโ โง ]โ))
    โ taโ ++โโโฆ ฮโ' โนโ A' , taโ โนโโ a โง โก _โนโโ_ {ฮ = ฮ} {ฮ = ฮโ ++โ ฮโ} {ฮ' = ฮโ' ++โ ฮโ'} (taโ ++โโโฆ ฮโ' , taโ โง) {A = A} {A' = A'} {!a!}

-- TelAdExtTelAdExtTelAd
  _++โโโฆ++โโโง :
    {ฮ : Ctx}
    {ฮโ ฮโ' : Tel ฮ} (taโ : TelAd ฮ ฮโ ฮโ')
    {ฮโ : Tel (ฮ โนโ[ + ] ฮโ)} {ฮโ' : Tel (ฮ โนโ[ + ] ฮโ')}
    (taโ :  TelAd (ฮ โนโ[ + ] ฮโ) ฮโ (ฮโ' [ id ฮ โนโนโ[ + ]โฆ _ , taโ โง ]โ))
    {ฮโ : Tel ((ฮ โนโ[ + ] ฮโ) โนโ[ + ] ฮโ)} {ฮโ' : Tel ((ฮ โนโ[ + ] ฮโ') โนโ[ + ] ฮโ')}
    (taโ :  TelAd _ ฮโ (ฮโ' [ id ฮ โนโนโ[ + ]โฆ ฮโ' , taโ โง โนโนโ[ + ]โฆ ฮโ' , taโ โง ]โ))
    โ taโ ++โโโฆ ฮโ' ++โ ฮโ' , taโ ++โโโฆ {!ฮโ!} , taโ โง  โง โก  (taโ ++โโโฆ ฮโ' , taโ โง) ++โโโฆ {!!} , taโ โง

-- TelAdExtIdTelAd
  _++โโโฆidโง :
    {ฮ : Ctx}
    {ฮโ : Tel ฮ}
    {ฮโ : Tel (ฮ โนโ[ + ] ฮโ)}
    โ idโโ {ฮ = ฮโ} ++โโโฆ ฮโ , idโโ  โง โก  idโโ

-- TelAdExtCompTelAd
  โ++โโโ  : {ฮ : Ctx} {ฮ ฮ' ฮ'' : Tel ฮ}
          (ta : TelAd ฮ ฮ ฮ') (ta' : TelAd ฮ ฮ' ฮ'')
          {ฮโ : Tel (ฮ โนโ[ + ] ฮ)} {ฮโ' : Tel (ฮ โนโ[ + ] ฮ')}
          {ฮโ'' : Tel (ฮ โนโ[ + ] ฮ'')}
          (taโ : TelAd _ ฮโ (ฮโ' [ id ฮ โนโนโ[ + ]โฆ _ , ta โง  ]โ))
          (taโ' : TelAd _ ฮโ' (ฮโ'' [ id ฮ โนโนโ[ + ]โฆ _ , ta' โง ]โ)) โ
          (ta' ++โโโฆ ฮโ'' , taโ' โง) โโโ (ta ++โโโฆ ฮโ' , taโ โง) โก ((ta' โโโ ta) ++โโโฆ ฮโ'' , (taโ' [ id (ฮ) โนโนโ[ + ]โฆ _ , ta โง ]โโ) โโโ taโ โง)

foo : {ฮ ฮ : Ctx} {ฮ ฮ' : Tel ฮ} (ta : TelAd ฮ ฮ ฮ') (ฯ : Sub ฮ ฮ) โ
  teladapt ((ta [ WkTel + ฮ ]โโ)
                [ ((ฯ โ WkTel + (ฮ [ ฯ ]โ)) ^โ +) โนโแตข[ + ]โฆ ฮ , vinst (ฮ [ ฯ ]โ) โง ]โโ)
           (vinst ฮ [ ((ฯ โ WkTel + (ฮ [ ฯ ]โ)) ^โ +) โนโแตข[ + ]โฆ ฮ , vinst (ฮ [ ฯ ]โ) โง ]โ) โก
  (vinst (ฮ' [ ฯ ]โ) [
         ((id ฮ โ WkTel + (ฮ [ ฯ ]โ))
              โนโแตข[ + ]โฆ ฮ' [ ฯ ]โ ,
                        teladapt ((ta [ ฯ ]โโ) [ WkTel + (ฮ [ ฯ ]โ) ]โโ)
                                               (vinst (ฮ [ ฯ ]โ)) โง) ]โ)
foo {ฮ = ฮ} {ฮ' = ฮ'} ta ฯ = sym (SubHdแตข (WkTel + (ฮ [ ฯ ]โ)) (ฮ' [ ฯ ]โ) (teladapt (ta [ ฯ โ WkTel + (ฮ [ ฯ ]โ) ]โโ) (vinst (ฮ [ ฯ ]โ))))
{-#REWRITE foo #-}

postulate
-- SubTelAdOnExtTel
  โนโ[] : {ฮ ฮ : Ctx} {ฮ ฮ' : Tel ฮ} (ta : TelAd ฮ ฮ ฮ') {A : Ty (ฮ โนโ[ + ] ฮ)} {A' : Ty (ฮ โนโ[ + ] ฮ')} (a : Ad _ A (A' [ id ฮ โนโนโ[ + ]โฆ ฮ' , ta โง ]โ)) (ฯ : Sub ฮ ฮ)
    โ (_โนโโ_ {ฮ = ฮ} {ฮ' = ฮ'} ta {A = A} {A' = A'} a)[ ฯ ]โโ โก _โนโโ_ {ฮ = ฮ [ ฯ ]โ} {ฮ' = ฮ' [ ฯ ]โ} (ta [ ฯ ]โโ) (a [ (ฯ โ WkTel + (ฮ [ ฯ ]โ)) โนโแตข[ + ]โฆ ฮ , vinst (ฮ [ ฯ ]โ) โง ]โ)

-- SubTelAdOnExtTelAd
  ++โโ[] : {ฮ ฮ : Ctx} {ฮ ฮ' : Tel ฮ} (taโ : TelAd ฮ ฮ ฮ') {A : Tel (ฮ โนโ[ + ] ฮ)} {A' : Tel (ฮ โนโ[ + ] ฮ')} (taโ : TelAd _ A (A' [ id ฮ โนโนโ[ + ]โฆ ฮ' , taโ โง ]โ)) (ฯ : Sub ฮ ฮ)
    โ (taโ ++โโโฆ A' , taโ โง )[ ฯ ]โโ โก (taโ [ ฯ ]โโ) ++โโโฆ A' [ (ฯ โ WkTel + (ฮ' [ ฯ ]โ)) โนโแตข[ + ]โฆ ฮ' , vinst (ฮ' [ ฯ ]โ) โง ]โ , taโ [ (ฯ โ WkTel + (ฮ [ ฯ ]โ)) โนโแตข[ + ]โฆ ฮ , vinst (ฮ [ ฯ ]โ) โง ]โโ โง


  โฆโง[]โ : (ฮ ฮ ฮ : Ctx) (ฯ ฮพ : Sub ฮ ฮ) (ฮผ : Trans ฮ ฮ ฯ ฮพ) (ฯ : Sub ฮ ฮ)
         (ฮ : Tel ฮ) โ ฮ โฆ ฮผ โงโ [ ฯ ]โโ โก ฮ โฆ whiskerRight ฮผ ฯ โงโ
  []โฆโงโ : (ฮ ฮ ฮ : Ctx) (ฯ : Sub ฮ ฮ) (ฯ ฮพ : Sub ฮ ฮ) (ฮผ : Trans ฮ ฮ ฯ ฮพ)
         (ฮ : Tel ฮ) โ ฮ [ ฯ ]โ โฆ ฮผ โงโ โก (ฮ โฆ whiskerLeft ฯ ฮผ โงโ)
  {-#REWRITE []โฆโงโ #-}


{- Appendix C.6 : Type variables -}
postulate
-- CtxTy
  _โธ[_]โฆ_,_โง :  (ฮ : Ctx) (d : Dir) โ Tel (ฮ ^ d) โ Dir โ Ctx

-- SubTy
  _โธโ[_]โฆ_,_โง : {d' : Dir} {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (d : Dir) (ฮ : Tel (ฮ ^ d)) โ Ty ((ฮ โนโ[ d ] (ฮ [ ฯ ^โ d ]โ)) ^ d') โ Sub ฮ (ฮ โธ[ d ]โฆ ฮ , d' โง)


-- TransAd+
  _โธโโโฆ_โง_ : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ}
          (ฮผ : Trans ฮ ฮ ฯ ฯ)
          {ฮ : Tel ฮ}
          (d : Dir)
          {A : Ty ((ฮ โนโ[ + ] (ฮ [ ฯ ]โ)) ^ d)}
          {B : Ty ((ฮ โนโ[ + ] (ฮ [ ฯ ]โ)) ^ d)}
          โ Ad _ A (B [ (id ฮ โนโนโ[ + ]โฆ _ , ฮ โฆ ฮผ โงโ โง) ^โ d ]โ)
          โ Trans ฮ (ฮ โธ[ + ]โฆ ฮ , d โง) (ฯ โธโ[ + ]โฆ ฮ , A โง) ((ฯ โธโ[ + ]โฆ ฮ , B โง))


-- TransAd-
  _โธโโโฆ_โง_ : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ}
          (ฮผ : Trans ฮ ฮ ฯ ฯ)
          {ฮ : Tel (ฮ ^ -)}
          (d : Dir)
          {A : Ty ((ฮ โนโ[ - ] (ฮ [ ฯ ^โ - ]โ)) ^ d)}
          {B : Ty ((ฮ โนโ[ - ] (ฮ [ ฯ ^โ - ]โ)) ^ d)}
          โ Ad _ A (B [ (id ฮ โนโนโ[ - ]โฆ _ , ฮ โฆ ฮผ ^โ - โงโ โง) ^โ d ]โ)
          โ Trans ฮ (ฮ โธ[ - ]โฆ ฮ , d โง) ((ฯ โธโ[ - ]โฆ ฮ , B โง)) (ฯ โธโ[ - ]โฆ ฮ , A โง)

-- WkTy
  WkTy  : (d : Dir) {ฮ : Ctx}  (ฮ : Tel (ฮ ^ d)) (d' : Dir) โ Sub (ฮ โธ[ d ]โฆ ฮ , d' โง) ฮ

-- VarZTy
  tyvz  : (d : Dir) {ฮ : Ctx} (ฮ : Tel (ฮ ^ d)) โ Ty ((ฮ โธ[ d ]โฆ ฮ , + โง) โนโ[ d ]  ( ฮ [ (WkTy d {ฮ} ฮ +) ^โ d ]โ))

-- CtxTyDual
  โธโฆโง^- : {ฮ : Ctx} {ฮ : Tel (ฮ ^ d)} โ (ฮ โธ[ d ]โฆ ฮ , d' โง) ^ - โก (ฮ ^ -) โธ[ โ d ]โฆ ฮ , โ d' โง
  {-#REWRITE โธโฆโง^- #-}

-- WkTyDual
  WkTy^- : {ฮ : Ctx} {ฮ : Tel (ฮ ^ d)} โ (WkTy d {ฮ} ฮ d') ^โ - โก WkTy (โ d) {ฮ ^ - } ฮ (โ d')
  {-#REWRITE WkTy^- #-}

-- SubTyDual
  โธโ^- : {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (d : Dir) (ฮ : Tel (ฮ ^ d)) (A : Ty ((ฮ โนโ[ d ] (ฮ [ ฯ ^โ d ]โ)) ^ d')) โ
    (_โธโ[_]โฆ_,_โง {d'} ฯ d ฮ A) ^โ - โก ((ฯ ^โ -) โธโ[ โ d ]โฆ ฮ , A โง)
  {-#REWRITE โธโ^- #-}

dร-d : (d d' : Dir) โ d ร (โ d') โก (โ d) ร d'
dร-d = {!!}
{-#REWRITE dร-d #-}

WkTel^-d : {d d' : Dir} {ฮ : Ctx} {ฮ : Tel (ฮ ^ d)} โ
  (WkTel {ฮ} d ฮ) ^โ (โ d') โก ((WkTel {ฮ ^ - } (โ d) ฮ) ^โ d')
WkTel^-d = {!!}
{-#REWRITE WkTel^-d #-}

postulate
-- -- TransAd+Dual
--   {-#REWRITE ฮผโปโป-spe #-}
  โธโโ^- : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ}
          (ฮผ : Trans ฮ ฮ ฯ ฯ)
          {ฮ : Tel ฮ}
          (d : Dir)
          {A : Ty ((ฮ โนโ[ + ] (ฮ [ ฯ ]โ)) ^ d)}
          {B : Ty ((ฮ โนโ[ + ] (ฮ [ ฯ ]โ)) ^ d)}
          (a : Ad _ A (B [ (id ฮ โนโนโ[ + ]โฆ _ , ฮ โฆ ฮผ โงโ โง) ^โ d ]โ)) โ
          (_โธโโโฆ_โง_ {ฮ} {ฮ} {ฯ} {ฯ} ฮผ {ฮ} d {A} {B} a) ^โ - โก _โธโโโฆ_โง_ {ฮ ^ - } {ฮ ^ - } {ฯ ^โ - } {ฯ ^โ - } (ฮผ ^โ -) {ฮ} (โ d) {A} {B} a

-- TransAd-Dual
  โธโโ^- : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ}
          (ฮผ : Trans ฮ ฮ ฯ ฯ)
          {ฮ : Tel (ฮ ^ -)}
          (d : Dir)
          {A : Ty ((ฮ โนโ[ - ] (ฮ [ ฯ ^โ - ]โ)) ^ d)}
          {B : Ty ((ฮ โนโ[ - ] (ฮ [ ฯ ^โ - ]โ)) ^ d)}
          (a : Ad _ A (B [ (id ฮ โนโนโ[ - ]โฆ _ , ฮ โฆ ฮผ ^โ - โงโ โง) ^โ d ]โ))
          โ (_โธโโโฆ_โง_ {ฮ} {ฮ} {ฯ} {ฯ} ฮผ {ฮ} d {A} {B} a) ^โ - โก _โธโโโฆ_โง_ {ฮ ^ - } {ฮ ^ - } {ฯ ^โ - } {ฯ ^โ - } (ฮผ ^โ -) {ฮ} (โ d) {A} {B} a

-- provable results to help agda's computations

โธโฆโง^d : {d d' d'' : Dir} {ฮ : Ctx} {ฮ : Tel (ฮ ^ d)} โ (ฮ โธ[ d ]โฆ ฮ , d' โง) ^ d'' โก (ฮ ^ d'') โธ[ d ร d'' ]โฆ ฮ , d' ร d'' โง
โธโฆโง^d {d} {d'} {+} {ฮ} {ฮ} = refl
โธโฆโง^d {d} {d'} { - } {ฮ} {ฮ} = refl
{-#REWRITE โธโฆโง^d #-}
WkTy^d : {d d' d'' : Dir} {ฮ : Ctx} {ฮ : Tel (ฮ ^ d)} โ (WkTy d {ฮ} ฮ d') ^โ d'' โก WkTy (d ร d'') {ฮ ^ d'' } ฮ (d' ร d'')
WkTy^d {d} {d'} {+} {ฮ} {ฮ} = refl
WkTy^d {d} {d'} { - } {ฮ} {ฮ} = refl
{-#REWRITE WkTy^d #-}
โธโ^d : {d d' d'' : Dir} {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (ฮ : Tel (ฮ ^ d)) (A : Ty ((ฮ โนโ[ d ] (ฮ [ ฯ ^โ d ]โ)) ^ d')) โ
       (_โธโ[_]โฆ_,_โง {d'} ฯ d ฮ A) ^โ d'' โก ((ฯ ^โ d'') โธโ[ d ร d'' ]โฆ ฮ , A โง)
โธโ^d {d} {d'} {+} {ฮ} {ฮ} ฯ ฮ A = refl
โธโ^d {d} {d'} { - } {ฮ} {ฮ} ฯ ฮ A = refl
{-#REWRITE โธโ^d #-}

lemmaโ : (d : Dir) {ฮ ฮ : Ctx} {ฮ : Tel (ฮ ^ d)} {ฯ ฯ : Sub ฮ ฮ} (ฮผ : Trans (ฮ ^ d) (ฮ ^ d) (ฯ ^โ d) (ฯ ^โ d))
         (ฮน : Inst (ฮ ^ d) ฮ) โ
         (id ฮ โนโนโ[ d ]โฆ ฮ [ ฯ ^โ d ]โ , ฮ โฆ ฮผ โงโ โง) โ (id ฮ โนโแตข[ d ]โฆ ฮ [ ฯ ^โ d ]โ , ฮน [ ฯ ^โ d ]โ โง)  โก
         id ฮ โนโแตข[ d ]โฆ ฮ [ ฯ ^โ d ]โ , ฮน [ ฯ ^โ d ]โ โง
lemmaโ d {ฮ} {ฮ} {ฮ} {ฯ} {ฯ}  ฮผ ฮน = โนโนโโโน d {ฮ = ฮ} {ฮ = ฮ} {ฯ = id ฮ} {ฯ = id ฮ}{A = ฮ [ ฯ ^โ d ]โ} {B = ฮ [ ฯ ^โ d ]โ} (ฮน [ ฯ ^โ d ]โ) (ฮ โฆ ฮผ โงโ)
{-#REWRITE lemmaโ #-}

lemmaโ :  (ฮ : Ctx) (ฮ : Ctx) (ฯ : Sub ฮ ฮ) (ฯ : Sub ฮ ฮ)
          (ฮผ : Trans ฮ ฮ ฯ ฯ) (ฮ : Tel ฮ) (ฮน : Inst ฮ (ฮ [ ฯ ]โ)) โ
          ((ฮ โฆ ฮผ โงโ) [ WkTel + (ฮ [ ฯ ]โ) ]โโ) [ id ฮ โนโแตข[ + ]โฆ ฮ [ ฯ ]โ , ฮน โง ]โโ โก ฮ โฆ ฮผ โงโ
lemmaโ ฮ ฮ ฯ ฯ ฮผ ฮ ฮน = [โ]โโ (ฮ โฆ ฮผ โงโ) (WkTel + (ฮ [ ฯ ]โ)) (id ฮ โนโแตข[ + ]โฆ ฮ [ ฯ ]โ , ฮน โง)
{-#REWRITE lemmaโ #-}


postulate
-- SubTlTy
  SubTlTy : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {d d' : Dir} {ฮ : Tel (ฮ ^ d)} (A : Ty ((ฮ โนโ[ d ] (ฮ [ ฯ ^โ d ]โ)) ^ d')) โ (WkTy d ฮ d') โ (ฯ โธโ[ d ]โฆ ฮ , A โง) โก ฯ
  {-#REWRITE SubTlTy #-}

-- SubTyExtVarZ
  SubHdTy : {d : Dir} {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (ฮ : Tel (ฮ ^ d))
            (A : Ty (ฮ โนโ[ d ] (ฮ [ ฯ ^โ d ]โ))) (ฮน : Inst (ฮ ^ d) (ฮ [ ฯ ^โ d ]โ)) โ
            (tyvz d {ฮ} ฮ) [ (ฯ โธโ[ d ]โฆ ฮ , A โง) โนโแตข[ d ]โฆ ฮ [ (WkTy d {ฮ} ฮ +) ^โ d ]โ , ฮน โง ]โ โก A [ id ฮ โนโแตข[ d ]โฆ ฮ [ ฯ ^โ d ]โ , ฮน โง ]โ
  {-#REWRITE SubHdTy #-}

-- SubEtaTy
  SubEtaTy : {ฮ ฮ : Ctx} {A : Tel (ฮ ^ d)} (ฯ : Sub ฮ (ฮ โธ[ d ]โฆ A  , + โง)) โ
             ((WkTy d A +) โ ฯ) โธโ[ d ]โฆ A , tyvz d {ฮ = ฮ} A [ ฯ โนโนโ[ d ]โฆ A [ WkTy + A d ]โ , idโโ โง  ]โ โง โก ฯ
  {-#REWRITE SubEtaTy #-}

-- -- Provable lemma needed for computation:
-- SubHdTy+ : {ฮ ฮ : Ctx} (ฯ : Sub ฮ ฮ) (ฮ : Tel ฮ) (A : Ty (ฮ โนโ[ + ] (ฮ [ ฯ ]โ))) (ฮน : Inst ฮ (ฮ [ ฯ ]โ)) โ
--             (tyvz + {ฮ} ฮ) [ (ฯ โธโ[ + ]โฆ ฮ , A โง) โนโแตข[ + ]โฆ ฮ [ WkTy + {ฮ} ฮ + ]โ , ฮน โง ]โ โก A [ id ฮ โนโแตข[ + ]โฆ ฮ [ ฯ ^โ + ]โ , ฮน โง ]โ
-- SubHdTy+ ฯ = SubHdTy {+} ฯ
-- {-#REWRITE SubHdTy+ #-}

-- ฯโปโป-spe : {ฮ ฮ : Ctx} (ฯ : Sub ฮ (ฮ ^ -)) โ (ฯ ^โ -) ^โ - โก ฯ
-- ฯโปโป-spe = ฯโปโป
-- {-#REWRITE ฯโปโป-spe #-}

postulate
-- TransTlAd+
  whiskerโธโ : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ}
          (ฮผ : Trans ฮ ฮ ฯ ฯ)
          {ฮ : Tel ฮ}
          (d : Dir)
          {A : Ty ((ฮ โนโ[ + ] (ฮ [ ฯ ]โ)) ^ d)}
          {B : Ty ((ฮ โนโ[ + ] (ฮ [ ฯ ]โ)) ^ d)}
          (a : Ad _ A (B [ (id ฮ โนโนโ[ + ]โฆ _ , ฮ โฆ ฮผ โงโ โง) ^โ d ]โ)) โ
          whiskerLeft (WkTy + ฮ d) (_โธโโโฆ_โง_ {ฮ} {ฮ} {ฯ} {ฯ} ฮผ {ฮ} d {A} {B} a) โก ฮผ

-- TransTlAd-
  whiskerโธโ : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ}
          (ฮผ : Trans ฮ ฮ ฯ ฯ)
          {ฮ : Tel (ฮ ^ -)}
          (d : Dir)
          {A : Ty ((ฮ โนโ[ - ] (ฮ [ ฯ ^โ - ]โ)) ^ d)}
          {B : Ty ((ฮ โนโ[ - ] (ฮ [ ฯ ^โ - ]โ)) ^ d)}
          (a : Ad _ A (B [ (id ฮ โนโนโ[ - ]โฆ _ , ฮ โฆ ฮผ ^โ - โงโ โง) ^โ d ]โ))
          โ whiskerLeft (WkTy - ฮ d) (_โธโโโฆ_โง_ {ฮ} {ฮ} {ฯ} {ฯ} ฮผ {ฮ} d {A} {B} a) โก ฮผ

{- Derivable operation -}
_wโนโนโโโฆ_,_โง : {ฮ ฮ : Ctx}
              {ฯ : Sub ฮ ฮ}
              {ฯ : Sub ฮ ฮ}
              (ฮผ : Trans ฮ ฮ ฯ ฯ)
              {ฮ : Tel ฮ}
              (ฮ' : Tel ฮ)
              (t : TelAd ฮ ฮ (ฮ' [ ฯ ]โ)) โ
              Trans (ฮ โนโ[ + ] ฮ) (ฮ โนโ[ + ] ฮ') (ฯ โนโนโ[ + ]โฆ ฮ' , t โง) (ฯ โนโนโ[ + ]โฆ ฮ' , (ฮ' โฆ ฮผ โงโ) โโโ t โง)
_wโนโนโโโฆ_,_โง = {!!}

_wโนโนโโโฆ_,_โง : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ} (ฮผ : Trans ฮ ฮ ฯ ฯ) {ฮ : Tel (ฮ ^ -)} (ฮ' : Tel (ฮ ^ -)) (t : TelAd (ฮ ^ -) ฮ (ฮ' [ ฯ ^โ - ]โ)) โ Trans (ฮ โนโ[ - ] ฮ) (ฮ โนโ[ - ] ฮ') (ฯ โนโนโ[ - ]โฆ ฮ' , t โง) (ฯ โนโนโ[ - ]โฆ ฮ' , (ฮ' โฆ ฮผ ^โ - โงโ) โโโ t โง)
_wโนโนโโโฆ_,_โง = {!!}

SubEtaTyโ : {ฮ ฮ : Ctx} {A : Tel ฮ} (ฯ : Sub ฮ (ฮ โธ[ + ]โฆ A  , + โง)) โ
             ((WkTy + A +) โ ฯ) โธโ[ + ]โฆ A , tyvz + {ฮ = ฮ} A [ ฯ โนโนโ[ + ]โฆ A [ WkTy + A + ]โ , idโโ โง  ]โ โง โก ฯ
SubEtaTyโ ฯ = SubEtaTy ฯ
{-#REWRITE SubEtaTyโ #-}

foo1 : {ฮ ฮ : Ctx}
          {ฮ : Tel ฮ}
          {ฯ : Sub ฮ (ฮ โธ[ + ]โฆ ฮ , + โง)}
          {ฯ : Sub ฮ (ฮ โธ[ + ]โฆ ฮ , + โง)}
          (ฮผ : Trans ฮ (ฮ โธ[ + ]โฆ ฮ , + โง) ฯ ฯ) โ
  vinst ((ฮ [ WkTy + ฮ + ]โ) [ ฯ ^โ + ]โ) [
    ((WkTel + (ฮ [ WkTy + ฮ + โ ฯ ]โ) ^โ +) โนโแตข[ + ]โฆ ฮ [ WkTy + ฮ + โ ฯ ]โ , teladapt ((ฮ โฆ whiskerLeft (WkTy + ฮ +) ฮผ โงโ) [ WkTel + (ฮ [ WkTy + ฮ + โ ฯ ]โ) ]โโ) ((vinst (ฮ [ WkTy + ฮ + โ ฯ ]โ))) โง) ^โ + ]โ
   โก teladapt ((ฮ โฆ whiskerLeft (WkTy + ฮ +) ฮผ โงโ) [ WkTel + (ฮ [ WkTy + ฮ + โ ฯ ]โ) ]โโ) (vinst (ฮ [ WkTy + ฮ + โ ฯ ]โ))
foo1 = {!!}
{-#REWRITE foo1 #-}

postulate
-- -- TransAdEta
--   TransAdEta : {ฮ ฮ : Ctx}
--           {ฮ : Tel ฮ}
--           {ฯ : Sub ฮ (ฮ โธ[ + ]โฆ ฮ , + โง)}
--           {ฯ : Sub ฮ (ฮ โธ[ + ]โฆ ฮ , + โง)}
--           (ฮผ : Trans ฮ (ฮ โธ[ + ]โฆ ฮ , + โง) ฯ ฯ) โ
--           ฮผ โก _โธโโโฆ_โง_ {ฮ} {ฮ} {(WkTy + ฮ +) โ ฯ} {(WkTy + ฮ +) โ ฯ} (whiskerLeft (WkTy + ฮ +) ฮผ) {ฮ} + {(tyvz + ฮ) [ ฯ โนโนโ[ + ]โฆ ฮ [ WkTy + ฮ + ]โ , idโโ โง ]โ} {(tyvz + ฮ) [ ฯ โนโนโ[ + ]โฆ ฮ [ WkTy + ฮ + ]โ , idโโ โง ]โ} ((tyvz + ฮ) โฆ ฮผ wโนโนโโโฆ ฮ [ WkTy + ฮ + ]โ , idโโ โง โง)

-- -- TransAdEta-
--   TransAdEta- : {ฮ ฮ : Ctx}
--           {ฮ : Tel (ฮ ^ -)}
--           {ฯ : Sub ฮ (ฮ โธ[ - ]โฆ ฮ , + โง)}
--           {ฯ : Sub ฮ (ฮ โธ[ - ]โฆ ฮ , + โง)}
--           (ฮผ : Trans ฮ (ฮ โธ[ - ]โฆ ฮ , + โง) ฯ ฯ) โ
--           ฮผ โก _โธโโโฆ_โง_ {ฮ} {ฮ} {(WkTy - ฮ +) โ ฯ} {(WkTy - ฮ +) โ ฯ} (whiskerLeft (WkTy - ฮ +) ฮผ) {ฮ} + {(tyvz - ฮ) [ ฯ โนโนโ[ - ]โฆ ฮ [ WkTy + ฮ - ]โ , idโโ โง ]โ} {(tyvz - ฮ) [ ฯ โนโนโ[ - ]โฆ ฮ [ WkTy + ฮ - ]โ , idโโ โง ]โ} ((tyvz - ฮ) โฆ ฮผ wโนโนโโโฆ ฮ [ WkTy + ฮ - ]โ , idโโ โง โง)

-- TransHdAd
  -- TransHdAd : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ}
  --             (ฮผ : Trans ฮ ฮ ฯ ฯ)
  --             {ฮ : Tel ฮ}
  --             {A : Ty (ฮ โนโ[ + ] (ฮ [ ฯ ]โ))}
  --             {B : Ty (ฮ โนโ[ + ] (ฮ [ ฯ ]โ))}
  --             (a : Ad (ฮ โนโ[ + ] (ฮ [ ฯ ]โ)) A (B [ id ฮ โนโนโ[ + ]โฆ _ , ฮ โฆ ฮผ โงโ โง ]โ))
  --             (ฮน : Inst ฮ (ฮ [ ฯ ]โ)) โ
  --             (tyvz + {ฮ} ฮ โฆ (_โธโโ_ {+} {ฮ} {ฮ} {ฯ} {ฯ} ฮผ {ฮ} {A} {B} a) โนโแตขโโฆ ฮ [ WkTy + ฮ + ]โ , ฮน โง โง) โก (a [ id ฮ โนโแตข[ + ]โฆ ฮ [ ฯ ]โ , ฮน โง ]โ)

  TransHdAd : {ฮ ฮ : Ctx} {ฯ : Sub ฮ ฮ} {ฯ : Sub ฮ ฮ}
          (ฮผ : Trans ฮ ฮ ฯ ฯ)
          {ฮ : Tel ฮ}
          {A : Ty (ฮ โนโ[ + ] (ฮ [ ฯ ]โ))}
          {B : Ty (ฮ โนโ[ + ] (ฮ [ ฯ ]โ))}
          (a : Ad _ A (B [ (id ฮ โนโนโ[ + ]โฆ _ , ฮ โฆ ฮผ โงโ โง) ]โ))
          (ฮน : Inst ฮ (ฮ [ ฯ ]โ)) โ
          ?


-- -- These rules are not necessary for this file. Are they necessary for the other files?:
-- {-#REWRITE *โassoc *โid id*โ #-}
-- {-#REWRITE idwhiskerLeft whiskerLeftid *โwhiskerLeft whiskerLeftโ idwhiskerRight whiskerRightid โwhiskerRight whiskerRight*โ #-}
-- {-#REWRITE โโassoc โโid idโโ #-}
-- {-#REWRITE โฆโโโง โฆwhiskerRightโง โฆwhiskerLeftโง #-}
-- {-#REWRITE AdaptTrans TmTrans #-}
-- {-#REWRITE โโโป #-}
-- {-#REWRITE id^โ- *โ^โ- #-}
-- {-#REWRITE ฮผโปแต #-}
-- {-#REWRITE โนโโ^- #-}
-- {-#REWRITE โนโโ^- #-}

-- I think these are not useful anymore
-- -- Specialisation to correct for  ฮผโปโป not firing
-- ฮผโปโป-spe : {d : Dir} {ฮ ฮ : Ctx} {ฯ ฯ : Sub ฮ ฮ} {ฮผ : Trans (ฮ ^ d) (ฮ ^ d) (ฯ ^โ d) (ฯ ^โ d)} โ (ฮผ ^โ -) ^โ - โก ฮผ
-- ฮผโปโป-spe {d} {ฮ} {ฮ} {ฯ} {ฯ} {ฮผ} = ฮผโปโป (ฯ ^โ d) (ฯ ^โ d) ฮผ
